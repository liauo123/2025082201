<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" />
  <title>éŸ³ç¬¦ç¯€æ‹ç·´ç¿’</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes beat { 0%{transform:scale(1);background-color:rgb(59,130,246)} 50%{transform:scale(1.2);background-color:rgb(37,99,235)} 100%{transform:scale(1);background-color:rgb(59,130,246)} }
    .beat-animation{animation:beat .18s ease-in-out}
    .note-display{font-size:3rem;font-weight:bold}

    /* å››å€‹å›ºå®šé–“æ ¼ï¼Œæ•¸å­—ç½®æ–¼éŸ³ç¬¦æ­£ä¸‹æ–¹ */
    .note-row{display:flex;justify-content:center;align-items:flex-end;gap:3.6rem}
    @media (min-width:768px){.note-row{gap:5.2rem}}
    .note-item{position:relative;display:flex;flex-direction:column;align-items:center}
    .note-symbol{font-size:2.6rem;line-height:1}
    .note-number{margin-top:.55rem;font-size:1rem;color:#6b7280;font-weight:700}

    /* é«˜äº® & æç¤º */
    .highlight-demo .note-symbol,
    .note-symbol.highlight-demo{color:#3b82f6;background:#dbeafe;padding:8px 12px;border-radius:12px;transform:scale(1.08);transition:all .18s ease}
    .highlight-user .note-symbol,
    .note-symbol.highlight-user{color:#16a34a;background:#dcfce7;padding:8px 12px;border-radius:12px;transform:scale(1.08);transition:all .12s ease;box-shadow:0 0 0 3px rgba(34,197,94,.25)}
    .note-hint{position:absolute;top:-1.6rem;padding:2px 8px;border-radius:9999px;font-size:.78rem;font-weight:800;color:#fff;pointer-events:none;white-space:nowrap}
    .note-hint.demo{background:linear-gradient(90deg,#6366f1,#8b5cf6)}
    .note-hint.user{background:linear-gradient(90deg,#10b981,#22c55e)}

    /* å€’æ•¸é®ç½© */
    .countdown-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:50}
    .countdown-number{font-size:6rem;font-weight:900;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,.35)}

    /* è§¸æ§å„ªåŒ–ï¼ˆå¹³æ¿ï¼‰ */
    html,body{height:100%;overscroll-behavior:none;-webkit-text-size-adjust:100%}
    .touch-friendly{-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;touch-action:manipulation}
    button{-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    *{-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
    .tap-giant{min-height:100px;min-width:260px;font-size:clamp(20px,3.2vw,28px);padding:1.25rem 2.5rem}
    .ctrl-btn{min-height:64px;padding:0.9rem 1.3rem;font-size:clamp(14px,2.4vw,18px)}
    @media (min-width:768px) and (max-width:1024px){
      .note-display{font-size:4.2rem}
      .note-symbol{font-size:3rem}
      .tap-giant{min-height:110px;min-width:300px}
      .note-number{font-size:1.05rem}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-800 min-h-screen flex items-center justify-center p-2 md:p-4 touch-friendly" oncontextmenu="return false;">
  <div class="bg-white rounded-3xl shadow-2xl p-4 md:p-8 max-w-4xl w-full mx-auto">
    <div class="text-center mb-6 md:mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">ğŸµ éŸ³ç¬¦ç¯€æ‹ç·´ç¿’ï¼ˆå¹³æ¿å„ªåŒ–ï¼‰</h1>
      <p class="text-sm md:text-base text-gray-600">æ¯å°ç¯€å›ºå®š 4 æ ¼ï¼ˆ4æ‹ï¼‰ã€‚æ¯æ ¼é¡¯ç¤ºï¼šâ™©ï¼ˆå››åˆ†ï¼‰æˆ– â™«ï¼ˆå–®å€‹å…«åˆ†ï¼‰ã€‚</p>
    </div>

    <!-- é€²åº¦é¡¯ç¤º -->
    <div class="flex justify-between items-center mb-4 md:mb-6 bg-gray-100 rounded-xl p-3 md:p-4">
      <div class="text-center">
        <div class="text-xl md:text-2xl font-bold text-blue-600" id="currentMeasure">1</div>
        <div class="text-xs md:text-sm text-gray-600">å°ç¯€ / 10</div>
      </div>
      <div class="text-center">
        <div class="text-xl md:text-2xl font-bold text-green-600" id="correctCount">0</div>
        <div class="text-xs md:text-sm text-gray-600">æ­£ç¢º</div>
      </div>
      <div class="text-center">
        <div class="text-xl md:text-2xl font-bold text-red-600" id="wrongCount">0</div>
        <div class="text-xs md:text-sm text-gray-600">éŒ¯èª¤</div>
      </div>
    </div>

    <!-- ç•¶å‰å°ç¯€ -->
    <div class="text-center mb-6 md:mb-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-4 md:p-6">
      <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-3 md:mb-4">ç¬¬ <span id="measureNumber">1</span> å°ç¯€</h3>
      <div class="note-display mb-3 md:mb-4" style="min-height: 120px;">
        <div id="currentMeasureNotes" class="note-row"></div>
      </div>
      <div class="text-xs md:text-sm text-gray-500 mt-3 md:mt-4" id="measureDescription">
        è¦å‰‡ï¼š<b>â™©å¿…é ˆæŒ‰ 1 ä¸‹ï¼ˆé€£æŒ‰ 2 ä¸‹éŒ¯ï¼‰</b>ã€<b>â™«å¿…é ˆã€Œé€£çºŒã€æŒ‰ 2 ä¸‹ï¼ˆæŒ‰ 1 ä¸‹éŒ¯ï¼‰</b>ï¼›
        æ¯ä¸€ä¸‹èˆ‡ç¯€å¥éŸ³æ™‚é–“å·®<b>è¶…é 0.3 ç§’å°±éŒ¯</b>ã€‚åµæ¸¬äº‚æŒ‰æœƒç›´æ¥åˆ¤éŒ¯ã€‚
        é–‹å§‹ç·´ç¿’æ™‚æœƒ 3-2-1 å€’æ•¸ï¼Œä¸¦åœ¨å€’æ•¸å¾Œ<b>0.5 ç§’</b>æ‰é–‹å§‹ç™¼å‡ºç¯€å¥éŸ³ã€‚
      </div>
    </div>

    <!-- ç¯€æ‹å™¨ -->
    <div class="flex justify-center mb-4 md:mb-6">
      <div class="flex space-x-3 md:space-x-4" id="beatIndicator" aria-hidden="true">
        <div class="w-14 h-14 md:w-16 md:h-16 bg-gray-300 rounded-full flex items-center justify-center text-lg md:text-xl font-bold">1</div>
        <div class="w-14 h-14 md:w-16 md:h-16 bg-gray-300 rounded-full flex items-center justify-center text-lg md:text-xl font-bold">2</div>
        <div class="w-14 h-14 md:w-16 md:h-16 bg-gray-300 rounded-full flex items-center justify-center text-lg md:text-xl font-bold">3</div>
        <div class="w-14 h-14 md:w-16 md:h-16 bg-gray-300 rounded-full flex items-center justify-center text-lg md:text-xl font-bold">4</div>
      </div>
    </div>

    <!-- ä¸»æŒ‰éˆ•ï¼ˆå¤§è§¸æ§å€ï¼‰-->
    <div class="text-center mb-4 md:mb-6">
      <button id="tapButton" class="tap-giant bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-extrabold rounded-full shadow-lg transform transition-all duration-150 hover:scale-105 active:scale-95 touch-friendly" aria-label="é»æ“Šç¯€æ‹">
        é»æ“Šç¯€æ‹ï¼
      </button>
    </div>

    <!-- æ§åˆ¶æŒ‰éˆ• -->
    <div class="grid grid-cols-2 md:flex md:justify-center gap-2 md:gap-4 mb-4 md:mb-6">
      <button id="demoButton" class="ctrl-btn bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white font-bold rounded-xl touch-friendly">ğŸµ è½ç¤ºç¯„</button>
      <button id="startButton" class="ctrl-btn bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold rounded-xl touch-friendly">é–‹å§‹ç·´ç¿’</button>
      <button id="nextButton" class="ctrl-btn bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold rounded-xl touch-friendly" disabled>ä¸‹ä¸€å°ç¯€</button>
      <button id="resetButton" class="ctrl-btn bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold rounded-xl touch-friendly">é‡æ–°é–‹å§‹</button>
    </div>

    <!-- çµæœ -->
    <div id="resultMessage" class="text-center mb-4 md:mb-6 hidden">
      <div class="bg-gray-100 rounded-xl p-3 md:p-4">
        <div class="text-xl md:text-2xl font-bold mb-2" id="resultText"></div>
        <div class="text-xs md:text-sm text-gray-600" id="resultDetail"></div>
      </div>
    </div>

    <!-- èªªæ˜ -->
    <div class="bg-gray-50 rounded-xl p-3 md:p-4 text-xs md:text-sm text-gray-600">
      <h3 class="font-bold mb-2">éŸ³ç¬¦èªªæ˜ï¼š</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-1 md:gap-2">
        <div>â€¢ å››åˆ†éŸ³ç¬¦ (â™©)ï¼š1 æ‹ï¼ˆæ•´æ ¼ï¼Œéœ€æŒ‰ <b>1 ä¸‹</b>ï¼›é€£æŒ‰ 2 ä¸‹éŒ¯ï¼‰</div>
        <div>â€¢ å…«åˆ†éŸ³ç¬¦ (â™«)ï¼š0.5 æ‹ï¼ˆåŒä¸€æ ¼æœƒç™¼å…©ä¸‹è²ï¼›éœ€ã€Œé€£çºŒã€æŒ‰ <b>2 ä¸‹</b>ï¼›æŒ‰ 1 ä¸‹éŒ¯ï¼‰</div>
        <div>â€¢ æ­£ç¢ºï¼šæ¯ä¸€ä¸‹èˆ‡ç¯€å¥éŸ³æ™‚é–“å·® â‰¤ 0.3 ç§’ï¼›<b>è¶…é 0.3 ç§’å³éŒ¯</b></div>
      </div>
    </div>
  </div>

  <!-- å€’æ•¸é®ç½© -->
  <div id="countdownOverlay" class="countdown-mask hidden">
    <div id="countdownNumber" class="countdown-number">3</div>
  </div>

  <script>
    class RhythmPractice {
      constructor() {
        /* ç‹€æ…‹ */
        this.currentMeasure = 1;
        this.totalMeasures = 10;
        this.correctCount = 0;
        this.wrongCount = 0;
        this.isPlaying = false;
        this.currentBeat = 0;

        /* æ™‚åºè¨­å®š */
        this.bpm = 80;
        this.beatInterval = null;
        this.lastWholeBeatShown = -1;

        /* é¡Œå‹ï¼ˆç”±æ˜“åˆ°é›£ï¼‰ */
        this.measureBeats = []; // ['Q' æˆ– 'E'] * 4
        this.PATTERNS = [
          ['Q','Q','Q','Q'], // 1
          ['Q','Q','Q','Q'], // 2
          ['Q','Q','Q','E'], // 3
          ['Q','Q','E','Q'], // 4
          ['E','Q','Q','Q'], // 5
          ['Q','E','Q','Q'], // 6
          ['Q','Q','E','E'], // 7
          ['E','Q','E','Q'], // 8
          ['Q','E','Q','E'], // 9
          ['E','E','E','E']  // 10
        ];

        /* éŸ³æ•ˆ */
        this.audioContext = null;

        /* è©•é‡è³‡æ–™ */
        this.expectedTimesPerBeat = [[],[],[],[]]; // æ¯æ ¼ï¼ˆmsï¼‰
        this.tapTimesMs = [];                      // ä½¿ç”¨è€…é»æ“Šï¼ˆmsï¼‰
        this.toleranceMs = 300;                    // Â±0.3s
        this.scheduledBeatTimers = [];
        this.scheduledSecondTimers = [];

        /* äº‚æŒ‰åµæ¸¬ */
        this.lastTapAt = 0;                 // å»æŠ–
        this.spamMaxTaps = 10;              // ä¸€å°ç¯€ç¸½é»æ“Šéå¤š
        this.spamBurstWindowMs = 280;       // è¦–ç‚ºé€£çºŒäº‚æŒ‰çš„æ™‚é–“çª—
        this.spamBurstCount = 3;            // çª—å…§ >=3 æ¬¡

        this.initEls();
        this.bindEvents();
        this.generateMeasure();
      }

      initEls(){
        this.currentMeasureEl = document.getElementById('currentMeasure');
        this.correctCountEl = document.getElementById('correctCount');
        this.wrongCountEl = document.getElementById('wrongCount');
        this.measureNumberEl = document.getElementById('measureNumber');
        this.currentMeasureNotesEl = document.getElementById('currentMeasureNotes');
        this.measureDescriptionEl = document.getElementById('measureDescription');
        this.beatIndicator = document.getElementById('beatIndicator');
        this.tapButton = document.getElementById('tapButton');
        this.demoButton = document.getElementById('demoButton');
        this.startButton = document.getElementById('startButton');
        this.nextButton = document.getElementById('nextButton');
        this.resetButton = document.getElementById('resetButton');
        this.resultMessage = document.getElementById('resultMessage');
        this.resultText = document.getElementById('resultText');
        this.resultDetail = document.getElementById('resultDetail');
        this.countdownOverlay = document.getElementById('countdownOverlay');
        this.countdownNumber = document.getElementById('countdownNumber');
      }

      bindEvents(){
        /* â€”â€” éŸ³è¨Šè§£é–ï¼šç¬¬ä¸€æ¬¡è§¸æ§å°±å»ºç«‹/å–šé†’ â€”â€” */
        const unlockAudio = async () => {
          if (!this.audioContext){
            try{
              this.audioContext = new (window.AudioContext||window.webkitAudioContext)();
            }catch(e){ /* ignore */ }
          }
          if (this.audioContext && this.audioContext.state === 'suspended'){
            try{ await this.audioContext.resume(); }catch(e){}
          }
        };
        document.addEventListener('pointerdown', unlockAudio, {passive:false, once:true});

        /* â€”â€” ä¸»è¦æ“ä½œæ”¹ç”¨ Pointer Eventsï¼Œé¿å…å¹³æ¿ click é›™è§¸ç™¼ â€”â€” */
        this.tapButton.addEventListener('pointerdown', (e)=>{
          if (!e.isPrimary) return;
          e.preventDefault();
          this.tapButton.setPointerCapture?.(e.pointerId);
          this.handleTap();          // æŒ‰ä¸‹ç«‹åˆ»å›é¥‹éŸ³ + è¨˜éŒ„ï¼ˆè‹¥åœ¨ç·´ç¿’ä¸­ï¼‰
        }, {passive:false});

        this.demoButton.addEventListener('pointerdown', (e)=>{ if(!e.isPrimary) return; e.preventDefault(); this.playDemo(); }, {passive:false});
        this.startButton.addEventListener('pointerdown',(e)=>{ if(!e.isPrimary) return; e.preventDefault(); this.startPracticeWithCountdown(); }, {passive:false});
        this.nextButton.addEventListener('pointerdown', (e)=>{ if(!e.isPrimary) return; e.preventDefault(); this.nextMeasure(); }, {passive:false});
        this.resetButton.addEventListener('pointerdown',(e)=>{ if(!e.isPrimary) return; e.preventDefault(); this.resetPractice(); }, {passive:false});

        /* é˜²æ­¢æŒ‰éˆ•åœ¨å¹³æ¿ä¸Šæ‹–æ›³/é•·æŒ‰é¸å­— */
        [this.tapButton,this.demoButton,this.startButton,this.nextButton,this.resetButton].forEach(btn=>{
          btn.addEventListener('dragstart', ev=>ev.preventDefault());
        });
      }

      /* é¡Œç›®ç”Ÿæˆ */
      generateMeasure(){
        this.measureBeats = this.PATTERNS[this.currentMeasure-1] || ['Q','Q','Q','Q'];
        this.displayMeasure();
      }

      displayMeasure(){
        this.currentMeasureNotesEl.innerHTML = '';
        for (let i=0;i<4;i++){
          const beatType = this.measureBeats[i];
          const host = document.createElement('div');
          host.className = 'note-item';
          host.dataset.beatIndex = i;

          const sym = document.createElement('span');
          sym.className = 'note-symbol';
          sym.textContent = (beatType==='Q' ? 'â™©' : 'â™«');
          host.appendChild(sym);

          const num = document.createElement('div');
          num.className = 'note-number';
          num.textContent = (i+1);
          host.appendChild(num);

          this.currentMeasureNotesEl.appendChild(host);
        }
        this.measureNumberEl.textContent = this.currentMeasure;
        this.currentMeasureEl.textContent = this.currentMeasure;
      }

      /* DOM è¼”åŠ© */
      getBeatHosts(){ return this.currentMeasureNotesEl.querySelectorAll('.note-item'); }
      highlightBeat(idx, kind='demo'){ const host=this.getBeatHosts()[idx]; if(host) host.classList.add(kind==='demo'?'highlight-demo':'highlight-user'); }
      resetBeat(idx, kind='demo'){ const host=this.getBeatHosts()[idx]; if(host) host.classList.remove(kind==='demo'?'highlight-demo':'highlight-user'); }
      resetAllBeats(){
        this.getBeatHosts().forEach(h=>{
          h.classList.remove('highlight-demo','highlight-user');
          const old = h.querySelector('.note-hint'); if (old) old.remove();
        });
      }
      showNoteHint(idx,text,type){
        const host = this.getBeatHosts()[idx]; if(!host) return;
        const old = host.querySelector('.note-hint'); if (old) old.remove();
        const hint = document.createElement('div');
        hint.className = `note-hint ${type==='demo'?'demo':'user'}`;
        hint.textContent = text;
        host.appendChild(hint);
      }
      hideNoteHint(idx){
        const host=this.getBeatHosts()[idx]; if(!host) return;
        const old=host.querySelector('.note-hint'); if(old) old.remove();
      }

      /* ====== è½ç¤ºç¯„ï¼šå…«åˆ†ï¼åŒä¸€æ ¼é€£çºŒ 2 ä¸‹ ====== */
      playDemo(){
        if (this.isPlaying) return;
        this.demoButton.disabled = true;
        this.demoButton.textContent = 'æ’­æ”¾ä¸­...';

        this.resetBeatIndicator();
        this.resetAllBeats();

        const beatMs = (60/this.bpm)*1000;
        const qDurSec = (beatMs*0.92)/1000;
        const eDurSec = (beatMs*0.42)/1000;
        const secondHitDelay = beatMs*0.5;

        for (let i=0;i<4;i++){
          const t0 = i*beatMs;
          const type = this.measureBeats[i];

          setTimeout(()=>{
            this.highlightBeat(i,'demo');
            this.showNoteHint(i,'ç¤ºç¯„','demo');

            if (type==='Q'){
              this.playBeatSound(qDurSec,'triangle');
            }else{
              this.playBeatSound(eDurSec,'square');
              setTimeout(()=>this.playBeatSound(eDurSec,'square'), secondHitDelay);
            }

            setTimeout(()=>{
              this.resetBeat(i,'demo');
              this.hideNoteHint(i);
            }, beatMs-60);
          }, t0);
        }

        setTimeout(()=>{
          this.resetBeatIndicator();
          this.resetAllBeats();
          this.demoButton.disabled=false;
          this.demoButton.textContent='ğŸµ è½ç¤ºç¯„';
        }, 4*beatMs + 300);
      }

      /* ====== å€’æ•¸å¾Œé–‹å§‹ï¼ˆå†å»¶ 0.5s æ‰å‡ºç¯€å¥éŸ³ï¼‰ ====== */
      async startPracticeWithCountdown(){
        this.startButton.disabled = true;
        this.nextButton.disabled = true;
        this.resultMessage.classList.add('hidden');
        await this.showCountdown();
        setTimeout(()=>this.startPractice(500), 0); // å€’æ•¸çµæŸå¾Œå»¶é² 0.5s
      }
      showCountdown(){
        return new Promise((resolve)=>{
          const seq=[3,2,1]; let i=0;
          this.countdownNumber.textContent = seq[i];
          this.countdownOverlay.classList.remove('hidden');
          const tick=()=>{
            i++;
            if(i<seq.length){ this.countdownNumber.textContent=seq[i]; setTimeout(tick,800); }
            else{ this.countdownOverlay.classList.add('hidden'); resolve(); }
          };
          setTimeout(tick,800);
        });
      }

      /* ====== ç·´ç¿’ ====== */
      startPractice(delayMs=0){
        this.resetBeatIndicator();
        this.isPlaying = true;
        this.currentBeat = 0;
        this.tapTimesMs = [];
        this.expectedTimesPerBeat = [[],[],[],[]];
        this.clearScheduledTimers();
        this.lastWholeBeatShown = -1;

        const beatMs = (60/this.bpm)*1000;
        const qDurSec = (beatMs*0.85)/1000;
        const eDurSec = (beatMs*0.40)/1000;
        const secondHitDelay = beatMs*0.5;

        for (let i=0;i<4;i++){
          const t0 = i*beatMs + delayMs;
          const type = this.measureBeats[i];

          const timer = setTimeout(()=>{
            this.expectedTimesPerBeat[i][0] = performance.now();
            if (type==='Q'){
              this.playBeatSound(qDurSec,'triangle');
            }else{
              this.playBeatSound(eDurSec,'square');
              const secondTimer = setTimeout(()=>{
                this.expectedTimesPerBeat[i][1] = performance.now();
                this.playBeatSound(eDurSec,'square');
              }, secondHitDelay);
              this.scheduledSecondTimers.push(secondTimer);
            }
          }, t0);
          this.scheduledBeatTimers.push(timer);
        }

        /* è¦–è¦ºç¯€æ‹ï¼ˆç”¨ rAF å¹³æ»‘ï¼‰ */
        const step = ()=>{
          if (!this.isPlaying) return;
          const elapsedBeats = (performance.now() - (this.startTimeRef || (this.startTimeRef = performance.now() + delayMs))) / ((60/this.bpm)*1000);
          this.currentBeat = Math.min(elapsedBeats, 4);
          this.updateBeatIndicator();
          if (this.currentBeat < 4) requestAnimationFrame(step);
          else this.endMeasure();
        };
        requestAnimationFrame(step);
      }

      clearScheduledTimers(){
        this.scheduledBeatTimers.forEach(id=>clearTimeout(id));
        this.scheduledSecondTimers.forEach(id=>clearTimeout(id));
        this.scheduledBeatTimers = [];
        this.scheduledSecondTimers = [];
        this.startTimeRef = null;
      }

      /* ====== é»æ“Šï¼šä¸€å®šè¦æœ‰è²éŸ³ï¼ˆå›é¥‹ï¼‰ï¼Œä¹Ÿè¨˜éŒ„æ™‚é–“ï¼ˆç·´ç¿’ä¸­ï¼‰ ====== */
      async handleTap(){
        const now = performance.now();
        if (now - this.lastTapAt < 90) return; // æ›´ç·Šçš„å»æŠ–ï¼Œå¹³æ¿æ‰‹æ„Ÿæ›´å¥½
        this.lastTapAt = now;

        // æŒ‰éµå›é¥‹éŸ³ï¼šå³ä½¿æœªé–‹å§‹ä¹Ÿè¦ç™¼è²
        this.playTapSound();

        if (!this.isPlaying) return; // æœªé–‹å§‹ç·´ç¿’ä¸è¨˜éŒ„

        // è¨˜éŒ„é»æ“Š
        this.tapTimesMs.push(now);

        // è¦–è¦ºå›é¥‹
        this.tapButton.classList.add('beat-animation');
        setTimeout(()=>this.tapButton.classList.remove('beat-animation'),180);
      }

      /* ====== çµæŸèˆ‡è©•åˆ† ====== */
      endMeasure(){
        this.isPlaying = false;
        this.clearScheduledTimers();

        const spam = this.detectSpam();
        const okByTiming = this.checkPerBeatExactly();
        const ok = (!spam) && okByTiming;

        this.showResult(ok, spam);

        this.startButton.disabled = false;
        if (this.currentMeasure < this.totalMeasures) this.nextButton.disabled = false;
      }

      /* åš´æ ¼ä¾ã€Œæ¯æ ¼éœ€è¦çš„æŒ‰éµæ•¸ã€ï¼š
         - Qï¼šå®¹è¨±çª—å…§ã€Œæ°å¥½ 1 ä¸‹ã€ï¼ˆ>0.3sã€0 æˆ– â‰¥2 çš†éŒ¯ï¼‰
         - Eï¼šå®¹è¨±çª—å…§ã€Œæ°å¥½ 2 ä¸‹ã€ä¸”ç‚ºã€Œé€£çºŒå…©ä¸‹ã€ï¼Œå„è‡ªå°æ‡‰å…©æ“Šï¼ˆ>0.3sã€æ•¸é‡ä¸ç¬¦æˆ–ä¸é€£çºŒçš†éŒ¯ï¼‰
         - 4 æ ¼è‡³å°‘ 3 æ ¼æ­£ç¢ºï¼ˆ60%ï¼‰æ‰é
      */
      checkPerBeatExactly(){
        const taps = [...this.tapTimesMs].sort((a,b)=>a-b);
        const used = new Array(taps.length).fill(false);
        let beatsCorrect = 0;
        const within = (t, center) => Math.abs(t - center) <= this.toleranceMs;

        for (let i=0;i<4;i++){
          const type = this.measureBeats[i];
          const exps = this.expectedTimesPerBeat[i].filter(v=>typeof v==='number');
          if (exps.length === 0) continue;

          const inWinIdx = [];
          for (let j=0;j<taps.length;j++){
            if (used[j]) continue;
            if (exps.some(e=>within(taps[j], e))) inWinIdx.push(j);
          }

          if (type === 'Q'){
            if (inWinIdx.length === 1 && within(taps[inWinIdx[0]], exps[0])){
              used[inWinIdx[0]] = true;
              beatsCorrect++;
            } else {
              inWinIdx.forEach(idx=>used[idx]=true);
            }
          } else { // 'E'
            if (exps.length<2){ inWinIdx.forEach(idx=>used[idx]=true); continue; }
            const exactTwo = inWinIdx.length === 2;
            const consecutive = exactTwo && (inWinIdx[1] === inWinIdx[0] + 1);
            if (exactTwo && consecutive){
              const tA = taps[inWinIdx[0]], tB = taps[inWinIdx[1]];
              if (within(tA, exps[0]) && within(tB, exps[1])){
                used[inWinIdx[0]] = true;
                used[inWinIdx[1]] = true;
                beatsCorrect++;
              } else {
                inWinIdx.forEach(idx=>used[idx]=true);
              }
            } else {
              inWinIdx.forEach(idx=>used[idx]=true);
            }
          }
        }
        return (beatsCorrect/4) >= 0.6;
      }

      /* äº‚æŒ‰åµæ¸¬ */
      detectSpam(){
        const taps = [...this.tapTimesMs].sort((a,b)=>a-b);
        if (taps.length > this.spamMaxTaps) return true;

        let i = 0;
        for (let j=0;j<taps.length;j++){
          while (taps[j] - taps[i] > this.spamBurstWindowMs) i++;
          if (j - i + 1 >= this.spamBurstCount) return true;
        }
        return false;
      }

      showResult(ok, spam=false){
        this.resultMessage.classList.remove('hidden');
        if (ok){
          this.correctCount++;
          this.resultText.textContent='æ­£ç¢ºï¼';
          this.resultText.className='text-2xl font-bold mb-2 text-green-600';
          this.resultDetail.textContent='â™© æ°å¥½ 1 ä¸‹ï¼›â™« éœ€é€£çºŒæ°å¥½ 2 ä¸‹ï¼›æ¯ä¸€ä¸‹åœ¨ 0.3 ç§’å…§ã€‚';
          this.playCorrectSound();
        }else{
          this.wrongCount++;
          this.resultText.textContent='éœ€è¦ç·´ç¿’';
          this.resultText.className='text-2xl font-bold mb-2 text-red-600';
          this.resultDetail.textContent = spam
            ? 'åµæ¸¬åˆ°é€£çºŒäº‚æŒ‰ï¼ˆé»æ“Šéå¤šæˆ–éå¯†ï¼‰ã€‚'
            : 'å†è©¦ä¸€æ¬¡ï¼šâ™© åªèƒ½ 1 ä¸‹ï¼›â™« å¿…é ˆé€£çºŒ 2 ä¸‹ï¼›è¶…é 0.3 ç§’æˆ–å¤š/å°‘æŒ‰éƒ½åˆ¤éŒ¯ã€‚';
          this.playWrongSound();
        }
        this.correctCountEl.textContent=this.correctCount;
        this.wrongCountEl.textContent=this.wrongCount;

        if (this.currentMeasure >= this.totalMeasures){
          setTimeout(()=>this.showFinal(),1000);
        }
      }

      nextMeasure(){
        if (this.currentMeasure < this.totalMeasures){
          this.currentMeasure++;
          this.generateMeasure();
          this.nextButton.disabled = true;
          this.resultMessage.classList.add('hidden');
        }
      }

      showFinal(){
        const acc = (this.correctCount/this.totalMeasures*100).toFixed(1);
        let grade, comment, color;
        if (acc>=90){ grade='A+'; comment='ğŸ‰ å„ªç§€ï¼ä½ çš„ç¯€æ‹æ„Ÿéå¸¸æº–ç¢ºï¼'; color='text-green-600'; }
        else if (acc>=80){ grade='A'; comment='ğŸ‘ å¾ˆå¥½ï¼ç¹¼çºŒä¿æŒï¼'; color='text-green-500'; }
        else if (acc>=70){ grade='B+'; comment='ğŸ‘ ä¸éŒ¯ï¼å†å¤šç·´å¹¾æ¬¡æ›´ç©©å®šï¼'; color='text-blue-600'; }
        else if (acc>=60){ grade='B'; comment='ğŸ’ª é‚„å¯ä»¥ï¼æ³¨æ„æ¯æ‹èµ·é»èˆ‡å…«åˆ†çš„é€£çºŒé›™æŒ‰ã€‚'; color='text-blue-500'; }
        else if (acc>=50){ grade='C'; comment='ğŸ“š éœ€è¦åŠ å¼·ï¼å…ˆå¾å…¨å››åˆ†å†æŒ‘æˆ°å…«åˆ†ã€‚'; color='text-orange-500'; }
        else { grade='D'; comment='ğŸ¯ æŒçºŒç·´ç¿’ï¼è·Ÿè‘—ç¤ºç¯„åšç¯€æ‹åˆ†è¾¨ã€‚'; color='text-red-500'; }

        this.resultMessage.classList.remove('hidden');
        this.resultText.innerHTML = `
          <div class="text-center">
            <div class="text-4xl font-bold ${color} mb-4">ç·´ç¿’å®Œæˆï¼</div>
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 mb-4">
              <div class="text-6xl font-bold ${color} mb-2">${grade}</div>
              <div class="text-xl text-gray-700 mb-4">ç¸½æ­£ç¢ºç‡ï¼š${acc}%</div>
              <div class="grid grid-cols-3 gap-4 text-center mb-4">
                <div><div class="text-2xl font-bold text-green-600">${this.correctCount}</div><div class="text-sm text-gray-600">æ­£ç¢º</div></div>
                <div><div class="text-2xl font-bold text-red-600">${this.wrongCount}</div><div class="text-sm text-gray-600">éŒ¯èª¤</div></div>
                <div><div class="text-2xl font-bold text-blue-600">â€”</div><div class="text-sm text-gray-600">å®Œæˆæ™‚é–“</div></div>
              </div>
            </div>
            <div class="text-lg text-gray-700 leading-relaxed">${comment}</div>
          </div>`;
        this.resultDetail.textContent='';
        this.nextButton.disabled=true;
        this.playFinalSound(acc);
      }

      /* ====== å·¥å…· ====== */
      updateBeatIndicator(){
        const indicators = this.beatIndicator.children;
        const k = Math.floor(this.currentBeat);
        if (k !== this.lastWholeBeatShown){
          this.lastWholeBeatShown = k;
          for (let i=0;i<indicators.length;i++){
            indicators[i].className='w-14 h-14 md:w-16 md:h-16 bg-gray-300 rounded-full flex items-center justify-center text-lg md:text-xl font-bold';
          }
          if (k<4){
            indicators[k].className='w-14 h-14 md:w-16 md:h-16 bg-blue-500 rounded-full flex items-center justify-center text-lg md:text-xl font-bold text-white';
          }
        }
      }
      resetBeatIndicator(){
        const indicators = this.beatIndicator.children;
        for (let i=0;i<indicators.length;i++){
          indicators[i].className='w-14 h-14 md:w-16 md:h-16 bg-gray-300 rounded-full flex items-center justify-center text-lg md:text-xl font-bold';
        }
      }

      resetPractice(){
        this.isPlaying=false;
        this.clearScheduledTimers();
        this.currentMeasure=1; this.correctCount=0; this.wrongCount=0;
        this.currentBeat=0; this.tapTimesMs=[]; this.expectedTimesPerBeat=[[],[],[],[]];
        this.updateDisplay(); this.generateMeasure(); this.resetBeatIndicator();
        this.resultMessage.classList.add('hidden');
        this.startButton.disabled=false; this.nextButton.disabled=true;
        this.lastTapAt = 0; this.lastWholeBeatShown = -1;
      }

      updateDisplay(){
        this.currentMeasureEl.textContent=this.currentMeasure;
        this.correctCountEl.textContent=this.correctCount;
        this.wrongCountEl.textContent=this.wrongCount;
      }

      /* ====== è²éŸ³å·¥å…· ====== */
      async playSound(freq,durationSec,type='sine',gainValue=0.3){
        try{
          if (!this.audioContext) this.audioContext = new (window.AudioContext||window.webkitAudioContext)();
          if (this.audioContext.state==='suspended') await this.audioContext.resume();
          const osc=this.audioContext.createOscillator();
          const gain=this.audioContext.createGain();
          osc.connect(gain); gain.connect(this.audioContext.destination);
          osc.frequency.setValueAtTime(freq,this.audioContext.currentTime);
          osc.type=type;
          gain.gain.setValueAtTime(gainValue,this.audioContext.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01,this.audioContext.currentTime+durationSec);
          osc.start(this.audioContext.currentTime);
          osc.stop(this.audioContext.currentTime+durationSec);
        }catch(e){ console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:',e); }
      }
      playTapSound(){ this.playSound(900,0.09,'square',0.24); }           // æŒ‰éµå›é¥‹éŸ³ï¼ˆå¹³æ¿ç¨å¾®æ›´éŸ¿äº®ï¼‰
      playCorrectSound(){ this.playSound(523.25,0.2); setTimeout(()=>this.playSound(659.25,0.2),120); setTimeout(()=>this.playSound(783.99,0.26),260); }
      playWrongSound(){ this.playSound(220,0.38,'sawtooth'); }
      playBeatSound(durationSec=0.11,wave='square'){ this.playSound(800,durationSec,wave,0.3); }
      playFinalSound(accuracy){
        const acc = parseFloat(accuracy);
        if (acc>=80){
          this.playSound(523.25,0.26); setTimeout(()=>this.playSound(659.25,0.26),180); setTimeout(()=>this.playSound(783.99,0.26),360); setTimeout(()=>this.playSound(1046.5,0.38),540);
        }else if (acc>=60){
          this.playSound(440,0.24); setTimeout(()=>this.playSound(554.37,0.24),200); setTimeout(()=>this.playSound(659.25,0.32),420);
        }else{
          this.playSound(349.23,0.34); setTimeout(()=>this.playSound(392,0.34),320);
        }
      }
    }

    const practice = new RhythmPractice();
  </script>
</body>
</html>
